<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMG_FORENSICS_TOOLKIT</title>

    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/exifreader@4.23.0/dist/exif-reader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap"
        rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #000000;
            --bg-secondary: #0a0a0a;
            --border: #333333;
            --accent: #00ff41;
            --accent-alt: #f3ea5f;
            --text-primary: #00ff41;
            --text-secondary: #33ff66;
            --text-dim: #666666;
            --danger: #ff3333;
        }

        body {
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow: hidden;
            height: 100vh;
            font-size: 13px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }

        /* Typography */
        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-weight: 700;
            color: var(--accent);
        }

        h1 {
            font-size: 20px;
        }

        h2 {
            font-size: 16px;
        }

        h3 {
            font-size: 14px;
        }

        /* Header */
        .header {
            height: 50px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }

        .logo {
            font-size: 16px;
            font-weight: 700;
            color: var(--accent);
            cursor: pointer;
            user-select: none;
        }

        .logo:hover {
            text-shadow: 0 0 10px var(--accent);
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        /* Buttons */
        .btn {
            padding: 6px 14px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
        }

        .btn:hover {
            border-color: var(--accent);
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.3);
        }

        .btn-primary {
            background: var(--bg-primary);
            border-color: var(--accent);
            color: var(--accent);
        }

        /* Layout */
        .container {
            display: flex;
            height: calc(100vh - 50px - 30px);
        }

        .sidebar {
            width: 220px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            overflow-y: auto;
            flex-shrink: 0;
        }

        .nav-section {
            border-bottom: 1px solid var(--border);
            padding: 15px 0;
        }

        .nav-label {
            padding: 0 15px 10px;
            font-size: 10px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .nav-item {
            padding: 8px 15px;
            cursor: pointer;
            transition: all 0.1s;
            border-left: 2px solid transparent;
            color: var(--text-secondary);
        }

        .nav-item:hover {
            background: var(--bg-primary);
            border-left-color: var(--accent);
        }

        .nav-item.active {
            background: var(--bg-primary);
            border-left-color: var(--accent);
            color: var(--accent);
        }

        .content {
            flex: 1;
            overflow-y: auto;
            background: var(--bg-primary);
        }

        .content-wrapper {
            padding: 20px;
            max-width: 1400px;
        }

        /* Upload */
        .upload-view {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: calc(100vh - 130px);
            text-align: center;
        }

        .dropzone {
            width: 100%;
            max-width: 600px;
            padding: 60px 40px;
            border: 1px dashed var(--border);
            background: var(--bg-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .dropzone:hover,
        .dropzone.drag-over {
            border-color: var(--accent);
            box-shadow: inset 0 0 20px rgba(0, 255, 65, 0.1);
        }

        .dropzone-text {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 10px;
        }

        /* Cards */
        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 15px;
            margin-bottom: 15px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        .card-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--accent);
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 15px;
            border-left: 2px solid var(--accent);
        }

        .stat-label {
            font-size: 10px;
            color: var(--text-dim);
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--accent);
        }

        /* Preview */
        .preview {
            background: #000;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            text-align: center;
        }

        .preview img,
        .preview canvas {
            max-width: 100%;
            max-height: 500px;
            object-fit: contain;
        }

        /* Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .data-table th,
        .data-table td {
            padding: 8px;
            border-bottom: 1px solid var(--border);
            text-align: left;
        }

        .data-table th {
            color: var(--text-dim);
            width: 30%;
        }

        .data-table td {
            color: var(--text-secondary);
        }

        .data-table tr:last-child th,
        .data-table tr:last-child td {
            border-bottom: none;
        }

        /* Hex View */
        .hex-view {
            font-size: 11px;
            background: #000;
            padding: 15px;
            border: 1px solid var(--border);
            overflow-x: auto;
            line-height: 1.8;
        }

        .hex-line {
            display: flex;
            gap: 15px;
        }

        .hex-offset {
            color: var(--text-dim);
            width: 80px;
        }

        .hex-data {
            color: var(--text-secondary);
        }

        .hex-ascii {
            color: var(--accent);
        }

        .hex-highlight {
            color: var(--accent-alt);
            font-weight: 700;
        }

        /* Strings View */
        .strings-view {
            background: #000;
            padding: 15px;
            border: 1px solid var(--border);
            max-height: 500px;
            overflow-y: auto;
            font-size: 12px;
        }

        .string-item {
            padding: 4px 0;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border);
        }

        .string-item:last-child {
            border-bottom: none;
        }

        .string-highlight {
            color: var(--accent-alt);
            font-weight: 700;
        }

        /* Tabs */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 2px 8px;
            font-size: 10px;
            border: 1px solid var(--border);
            background: var(--bg-primary);
            margin-left: 10px;
        }

        .badge-success {
            border-color: var(--accent);
            color: var(--accent);
        }

        .badge-warning {
            border-color: var(--accent-alt);
            color: var(--accent-alt);
        }

        .badge-danger {
            border-color: var(--danger);
            color: var(--danger);
        }

        /* Footer */
        .footer {
            height: 30px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 20px;
            font-size: 11px;
            color: var(--text-dim);
            gap: 20px;
        }

        /* Modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal.open {
            opacity: 1;
            pointer-events: auto;
        }

        .modal img {
            max-width: 95vw;
            max-height: 95vh;
            border: 1px solid var(--accent);
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--accent);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .modal-close:hover {
            border-color: var(--accent);
        }

        /* Loading */
        .loading {
            color: var(--text-dim);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        /* Grid */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 15px;
        }

        /* Utilities */
        .hidden {
            display: none !important;
        }

        .mt-2 {
            margin-top: 10px;
        }

        .mb-2 {
            margin-bottom: 10px;
        }

        .text-danger {
            color: var(--danger);
        }

        .text-warning {
            color: var(--accent-alt);
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 180px;
            }

            .grid-2 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="logo" onclick="location.reload()">&gt;_ IMG_FORENSICS_TOOLKIT</div>
        <div class="header-actions">
            <button class="btn" onclick="exportJSON()" id="exportBtn" style="display: none;">EXPORT_JSON</button>
            <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">LOAD_FILE</button>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="nav-section">
                <div class="nav-label">ANALYSIS</div>
                <div class="nav-item active" onclick="switchTab('overview')">OVERVIEW</div>
                <div class="nav-item" onclick="switchTab('metadata')">METADATA</div>
                <div class="nav-item" onclick="switchTab('strings')">STRINGS</div>
                <div class="nav-item" onclick="switchTab('hex')">HEX_VIEW</div>
                <div class="nav-item" onclick="switchTab('threats')">THREATS</div>
                <div class="nav-item" onclick="switchTab('stego')">STEGANOGRAPHY</div>
                <div class="nav-item" onclick="switchTab('compression')">COMPRESSION</div>
            </div>
            <div class="nav-section">
                <div class="nav-label">TOOLS</div>
                <div class="nav-item" onclick="switchTab('visual')">VISUAL_ANALYSIS</div>
                <div class="nav-item" onclick="switchTab('ocr')">TEXT_EXTRACT</div>
            </div>
        </aside>

        <!-- Content -->
        <main class="content">
            <div class="content-wrapper">
                <!-- Upload View -->
                <div id="view-upload" class="view">
                    <div class="upload-view">
                        <div class="dropzone" id="dropzone">
                            <pre style="color: var(--accent); font-size: 24px;">[  FILE_DROP_ZONE  ]</pre>
                            <div class="dropzone-text">CLICK OR DROP IMAGE/FILE FOR ANALYSIS</div>
                            <div class="dropzone-text"
                                style="color: var(--text-dim); font-size: 11px; margin-top: 20px;">
                                SUPPORTED: JPG • PNG • WEBP • TIFF • GIF • BMP • ANY_BINARY
                            </div>
                        </div>
                        <input type="file" id="fileInput" style="display: none">
                    </div>
                </div>

                <!-- Analysis View -->
                <div id="view-analysis" class="view hidden">
                    <!-- Overview Tab -->
                    <div id="tab-overview" class="tab-content active">
                        <div class="stats-grid">
                            <div class="stat">
                                <div class="stat-label">FILE_SIZE</div>
                                <div class="stat-value" id="fileSize">--</div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">FILE_TYPE</div>
                                <div class="stat-value" id="fileType">--</div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">DIMENSIONS</div>
                                <div class="stat-value" id="dimensions">--</div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">THREAT_COUNT</div>
                                <div class="stat-value" id="threatCount">--</div>
                            </div>
                        </div>

                        <div class="preview">
                            <img id="mainPreview" src="" alt="Image Preview" onclick="zoomImage()">
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">QUICK_ANALYSIS</div>
                            </div>
                            <div id="quickAnalysis"></div>
                        </div>
                    </div>

                    <!-- Metadata Tab -->
                    <div id="tab-metadata" class="tab-content">
                        <h2 class="mb-2">METADATA_EXTRACTION</h2>
                        <div class="grid-2">
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title">BASIC_INFO</div>
                                </div>
                                <div id="basicInfo"></div>
                            </div>
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title">EXIF_DATA</div>
                                </div>
                                <div id="exifData"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Strings Tab -->
                    <div id="tab-strings" class="tab-content">
                        <h2 class="mb-2">STRING_EXTRACTION</h2>
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">PRINTABLE_STRINGS</div>
                                <span class="text-dim" id="stringCount">MIN_LENGTH: 4</span>
                            </div>
                            <div id="stringsView" class="strings-view"></div>
                        </div>
                    </div>

                    <!-- Hex View Tab -->
                    <div id="tab-hex" class="tab-content">
                        <h2 class="mb-2">HEX_DUMP</h2>
                        <div class="card mb-2">
                            <div class="card-header">
                                <div class="card-title">FILE_HEADER [FIRST_2KB]</div>
                                <span id="magicBytes" class="text-dim">MAGIC: --</span>
                            </div>
                            <div id="hexHeader" class="hex-view"></div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">FILE_FOOTER [LAST_2KB]</div>
                            </div>
                            <div id="hexFooter" class="hex-view"></div>
                        </div>
                    </div>

                    <!-- Threats Tab -->
                    <div id="tab-threats" class="tab-content">
                        <h2 class="mb-2">THREAT_INTELLIGENCE</h2>
                        <div id="threatResults"></div>
                    </div>

                    <!-- Steganography Tab -->
                    <div id="tab-stego" class="tab-content">
                        <h2 class="mb-2">STEGANOGRAPHY_ANALYSIS</h2>
                        <div class="card mb-2">
                            <div class="card-header">
                                <div class="card-title">BIT_PLANE_ANALYSIS</div>
                                <div style="display: flex; gap: 5px;">
                                    <button class="btn" onclick="setBitPlane(0)">BIT_0</button>
                                    <button class="btn" onclick="setBitPlane(1)">BIT_1</button>
                                    <button class="btn" onclick="setBitPlane(2)">BIT_2</button>
                                    <button class="btn" onclick="setBitPlane(3)">BIT_3</button>
                                    <button class="btn" onclick="setBitPlane(4)">BIT_4</button>
                                    <button class="btn" onclick="setBitPlane(5)">BIT_5</button>
                                    <button class="btn" onclick="setBitPlane(6)">BIT_6</button>
                                    <button class="btn" onclick="setBitPlane(7)">BIT_7</button>
                                </div>
                            </div>
                            <div class="preview">
                                <canvas id="bitPlaneCanvas"></canvas>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">APPENDED_DATA_CHECK</div>
                            </div>
                            <div id="appendedData"></div>
                        </div>
                    </div>

                    <!-- Compression Analysis Tab -->
                    <div id="tab-compression" class="tab-content">
                        <h2 class="mb-2">COMPRESSION_ANALYSIS</h2>
                        <div class="grid-2">
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title">COMPRESSION_VARIANCE</div>
                                </div>
                                <div class="preview">
                                    <canvas id="compressionCanvas"></canvas>
                                </div>
                                <div id="compressionStats" class="mt-2"></div>
                            </div>
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title">NOISE_VARIANCE</div>
                                </div>
                                <div class="preview">
                                    <canvas id="noiseCanvas"></canvas>
                                </div>
                                <div id="noiseStats" class="mt-2"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Visual Analysis Tab -->
                    <div id="tab-visual" class="tab-content">
                        <h2 class="mb-2">VISUAL_FORENSICS</h2>
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">FILTERS</div>
                                <div style="display: flex; gap: 5px;">
                                    <button class="btn" onclick="applyFilter('original')">ORIGINAL</button>
                                    <button class="btn" onclick="applyFilter('edge')">EDGE</button>
                                    <button class="btn" onclick="applyFilter('invert')">INVERT</button>
                                    <button class="btn" onclick="applyFilter('grayscale')">GRAYSCALE</button>
                                </div>
                            </div>
                            <div class="preview">
                                <canvas id="filterCanvas"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- OCR Tab -->
                    <div id="tab-ocr" class="tab-content">
                        <h2 class="mb-2">TEXT_EXTRACTION [OCR]</h2>
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">EXTRACTED_TEXT</div>
                                <button class="btn" onclick="runOCR()">RUN_OCR</button>
                            </div>
                            <div id="ocrResult"
                                style="background: #000; padding: 15px; border: 1px solid var(--border); min-height: 200px; white-space: pre-wrap;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Footer Status Bar -->
    <footer class="footer">
        <span>SHORTCUTS:</span>
        <span>CTRL+N: NEW</span>
        <span>CTRL+E: EXPORT</span>
        <span>1-9: TABS</span>
        <span id="statusText" style="margin-left: auto;">READY</span>
    </footer>

    <!-- Zoom Modal -->
    <div class="modal" id="zoomModal" onclick="closeZoom()">
        <div class="modal-close" onclick="closeZoom()">×</div>
        <img id="zoomImage" src="" onclick="event.stopPropagation()">
    </div>

    <script>
        // Application State
        const app = {
            file: null,
            image: null,
            fileData: null,
            currentTab: 'overview',
            currentBitPlane: 0
        };

        // DOM Elements
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('fileInput');
        const uploadView = document.getElementById('view-upload');
        const analysisView = document.getElementById('view-analysis');
        const statusText = document.getElementById('statusText');

        // Initialize
        function init() {
            setupEventListeners();
        }

        function setupEventListeners() {
            dropzone.addEventListener('click', () => fileInput.click());
            dropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropzone.classList.add('drag-over');
            });
            dropzone.addEventListener('dragleave', () => dropzone.classList.remove('drag-over'));
            dropzone.addEventListener('drop', handleDrop);
            fileInput.addEventListener('change', (e) => {
                if (e.target.files[0]) handleFile(e.target.files[0]);
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                    e.preventDefault();
                    fileInput.click();
                }
                if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                    e.preventDefault();
                    exportJSON();
                }
                // Tab switching 1-9
                if (e.key >= '1' && e.key <= '9' && !e.ctrlKey && !e.metaKey && app.file) {
                    const tabs = ['overview', 'metadata', 'strings', 'hex', 'threats', 'stego', 'compression', 'visual', 'ocr'];
                    const tab = tabs[parseInt(e.key) - 1];
                    if (tab) {
                        const navItem = document.querySelector(`[onclick*="${tab}"]`);
                        if (navItem) navItem.click();
                    }
                }
            });
        }

        function handleDrop(e) {
            e.preventDefault();
            dropzone.classList.remove('drag-over');
            if (e.dataTransfer.files.length) {
                handleFile(e.dataTransfer.files[0]);
            }
        }

        function handleFile(file) {
            app.file = file;
            statusText.textContent = 'LOADING...';

            // Read file as ArrayBuffer for binary analysis
            const reader = new FileReader();
            reader.onload = (e) => {
                app.fileData = new Uint8Array(e.target.result);

                // Try to load as image
                const imgReader = new FileReader();
                imgReader.onload = (e2) => {
                    const img = new Image();
                    img.onload = () => {
                        app.image = img;
                        startAnalysis();
                    };
                    img.onerror = () => {
                        app.image = null;
                        startAnalysis(); // Still allow hex/string analysis
                    };
                    img.src = e2.target.result;
                };
                imgReader.readAsDataURL(file);
            };
            reader.readAsArrayBuffer(file);
        }

        async function startAnalysis() {
            uploadView.classList.add('hidden');
            analysisView.classList.remove('hidden');
            document.getElementById('exportBtn').style.display = 'inline-block';

            // Update basic stats
            document.getElementById('fileSize').textContent = (app.file.size / 1024).toFixed(2) + ' KB';
            document.getElementById('fileType').textContent = app.file.type || 'UNKNOWN';

            if (app.image) {
                document.getElementById('dimensions').textContent = `${app.image.naturalWidth}×${app.image.naturalHeight}`;
                document.getElementById('mainPreview').src = app.image.src;
                document.getElementById('zoomImage').src = app.image.src;
            } else {
                document.getElementById('dimensions').textContent = 'N/A';
                document.getElementById('mainPreview').style.display = 'none';
            }

            // Run analyses
            await Promise.all([
                analyzeMetadata(),
                analyzeStrings(),
                analyzeHex(),
                analyzeThreats(),
                analyzeSteganography(),
                analyzeCompression()
            ]);

            statusText.textContent = 'ANALYSIS_COMPLETE';
        }

        // Metadata Analysis
        async function analyzeMetadata() {
            const basicInfo = `
                <table class="data-table">
                    <tr><th>FILENAME</th><td>${app.file.name}</td></tr>
                    <tr><th>SIZE</th><td>${(app.file.size / 1024).toFixed(2)} KB</td></tr>
                    <tr><th>TYPE</th><td>${app.file.type || 'application/octet-stream'}</td></tr>
                    <tr><th>MODIFIED</th><td>${new Date(app.file.lastModified).toISOString()}</td></tr>
                    ${app.image ? `<tr><th>DIMENSIONS</th><td>${app.image.naturalWidth}×${app.image.naturalHeight}</td></tr>` : ''}
                </table>
            `;
            document.getElementById('basicInfo').innerHTML = basicInfo;

            if (app.file.type.startsWith('image/')) {
                try {
                    const tags = await ExifReader.load(app.file);
                    let exifHtml = '<table class="data-table">';
                    for (let [key, value] of Object.entries(tags)) {
                        if (key !== 'MakerNote' && value.description) {
                            exifHtml += `<tr><th>${key}</th><td>${value.description}</td></tr>`;
                        }
                    }
                    exifHtml += '</table>';
                    document.getElementById('exifData').innerHTML = exifHtml;
                } catch (e) {
                    document.getElementById('exifData').innerHTML = '<div class="text-dim">NO_EXIF_DATA</div>';
                }
            } else {
                document.getElementById('exifData').innerHTML = '<div class="text-dim">NOT_AN_IMAGE</div>';
            }
        }

        // String Extraction
        function analyzeStrings() {
            return new Promise((resolve) => {
                statusText.textContent = 'EXTRACTING_STRINGS...';
                const minLength = 4;
                const strings = [];
                let current = '';

                // Extract ASCII strings
                for (let i = 0; i < app.fileData.length; i++) {
                    const byte = app.fileData[i];
                    if (byte >= 32 && byte <= 126) {
                        current += String.fromCharCode(byte);
                    } else {
                        if (current.length >= minLength) {
                            strings.push(current);
                        }
                        current = '';
                    }
                }
                if (current.length >= minLength) {
                    strings.push(current);
                }

                // Display strings
                let html = '';
                const flagPatterns = [
                    /flag\{[^\}]+\}/gi,
                    /CTF\{[^\}]+\}/gi,
                    /[A-Z0-9]{20,}/g,
                    /^[A-Za-z0-9+/]{20,}={0,2}$/gm // Base64-like
                ];

                strings.forEach(str => {
                    let highlighted = false;
                    flagPatterns.forEach(pattern => {
                        if (pattern.test(str)) {
                            html += `<div class="string-item"><span class="string-highlight">${str}</span></div>`;
                            highlighted = true;
                        }
                    });
                    if (!highlighted) {
                        html += `<div class="string-item">${str}</div>`;
                    }
                });

                document.getElementById('stringsView').innerHTML = html || '<div class="text-dim">NO_STRINGS_FOUND</div>';
                document.getElementById('stringCount').textContent = `FOUND: ${strings.length}`;
                resolve();
            });
        }

        // Hex Dump
        function analyzeHex() {
            statusText.textContent = 'GENERATING_HEX...';

            // Generate hex dump for first 2KB
            const headerSize = Math.min(2048, app.fileData.length);
            let headerHtml = '';
            for (let i = 0; i < headerSize; i += 16) {
                const line = generateHexLine(i, Math.min(16, headerSize - i));
                headerHtml += line;
            }
            document.getElementById('hexHeader').innerHTML = headerHtml;

            // Generate hex dump for last 2KB
            const footerStart = Math.max(0, app.fileData.length - 2048);
            let footerHtml = '';
            for (let i = footerStart; i < app.fileData.length; i += 16) {
                const line = generateHexLine(i, Math.min(16, app.fileData.length - i));
                footerHtml += line;
            }
            document.getElementById('hexFooter').innerHTML = footerHtml;

            // Detect magic bytes
            const magicBytes = Array.from(app.fileData.slice(0, 4))
                .map(b => b.toString(16).padStart(2, '0').toUpperCase())
                .join(' ');
            document.getElementById('magicBytes').textContent = `MAGIC: ${magicBytes}`;

            // Verify file type
            const magicMap = {
                'FF D8 FF': 'JPEG',
                '89 50 4E 47': 'PNG',
                '47 49 46 38': 'GIF',
                '42 4D': 'BMP',
                '49 49 2A 00': 'TIFF (LE)',
                '4D 4D 00 2A': 'TIFF (BE)',
                '52 49 46 46': 'WEBP'
            };

            const detected = Object.entries(magicMap).find(([sig]) =>
                magicBytes.startsWith(sig)
            );

            if (detected) {
                document.getElementById('magicBytes').innerHTML += ` <span class="badge badge-success">${detected[1]}</span>`;
            } else {
                document.getElementById('magicBytes').innerHTML += ` <span class="badge badge-warning">UNKNOWN</span>`;
            }
        }

        function generateHexLine(offset, length) {
            let hex = '';
            let ascii = '';

            for (let i = 0; i < 16; i++) {
                if (i < length) {
                    const byte = app.fileData[offset + i];
                    const hexByte = byte.toString(16).padStart(2, '0').toUpperCase();

                    // Highlight magic bytes in first line
                    if (offset === 0 && i < 4) {
                        hex += `<span class="hex-highlight">${hexByte}</span> `;
                    } else {
                        hex += hexByte + ' ';
                    }

                    ascii += (byte >= 32 && byte <= 126) ? String.fromCharCode(byte) : '.';
                } else {
                    hex += '   ';
                    ascii += ' ';
                }
            }

            return `<div class="hex-line"><span class="hex-offset">${offset.toString(16).padStart(8, '0').toUpperCase()}</span><span class="hex-data">${hex}</span><span class="hex-ascii">${ascii}</span></div>`;
        }

        // Threat Analysis
        function analyzeThreats() {
            statusText.textContent = 'SCANNING_THREATS...';
            const binary = new TextDecoder('utf-8', { fatal: false }).decode(app.fileData);

            const findings = {
                urls: [...new Set(binary.match(/https?:\/\/[^\s/$.?#].[^\s]*/gi) || [])],
                crypto: [...new Set([
                    ...(binary.match(/\b(bc1|[13])[a-zA-Z0-9]{25,39}\b/g) || []),
                    ...(binary.match(/\b0x[a-fA-F0-9]{40}\b/g) || [])
                ])],
                archives: []
            };

            // Check for ZIP signature
            if (binary.includes('PK\x03\x04')) findings.archives.push('ZIP_ARCHIVE');
            // Check for RAR signature
            if (binary.includes('Rar!')) findings.archives.push('RAR_ARCHIVE');

            const total = findings.urls.length + findings.crypto.length + findings.archives.length;
            document.getElementById('threatCount').textContent = total;

            let html = '<div class="grid-2">';
            html += `<div class="card"><div class="card-header"><div class="card-title">URLS [${findings.urls.length}]</div></div>`;
            html += findings.urls.length ? `<table class="data-table">${findings.urls.map(u => `<tr><td style="color: var(--accent-alt);">${u}</td></tr>`).join('')}</table>` : '<div class="text-dim">NONE</div>';
            html += '</div>';

            html += `<div class="card"><div class="card-header"><div class="card-title">CRYPTO [${findings.crypto.length}]</div></div>`;
            html += findings.crypto.length ? `<table class="data-table">${findings.crypto.map(c => `<tr><td style="color: var(--accent-alt);">${c}</td></tr>`).join('')}</table>` : '<div class="text-dim">NONE</div>';
            html += '</div>';

            html += `<div class="card"><div class="card-header"><div class="card-title">ARCHIVES [${findings.archives.length}]</div></div>`;
            html += findings.archives.length ? `<div class="text-danger">${findings.archives.join(', ')}</div>` : '<div class="text-dim">NONE</div>';
            html += '</div></div>';

            document.getElementById('threatResults').innerHTML = html;
        }

        // Steganography Analysis
        function analyzeSteganography() {
            if (!app.image) {
                document.getElementById('appendedData').innerHTML = '<div class="text-dim">NOT_AN_IMAGE</div>';
                return;
            }

            setBitPlane(0);

            // Check for appended data (data after EOI marker for JPG)
            if (app.file.type === 'image/jpeg') {
                const eoiMarker = [0xFF, 0xD9];
                let eoiIndex = -1;

                for (let i = 0; i < app.fileData.length - 1; i++) {
                    if (app.fileData[i] === eoiMarker[0] && app.fileData[i + 1] === eoiMarker[1]) {
                        eoiIndex = i + 2;
                    }
                }

                if (eoiIndex !== -1 && eoiIndex < app.fileData.length) {
                    const appendedSize = app.fileData.length - eoiIndex;
                    document.getElementById('appendedData').innerHTML = `
                        <table class="data-table">
                            <tr><th>EOI_MARKER_POS</th><td>${eoiIndex}</td></tr>
                            <tr><th>FILE_SIZE</th><td>${app.fileData.length}</td></tr>
                            <tr><th>APPENDED_BYTES</th><td class="text-danger">${appendedSize} BYTES</td></tr>
                            <tr><th>STATUS</th><td><span class="badge badge-danger">HIDDEN_DATA_DETECTED</span></td></tr>
                        </table>
                    `;
                } else {
                    document.getElementById('appendedData').innerHTML = '<table class="data-table"><tr><th>STATUS</th><td><span class="badge badge-success">NO_APPENDED_DATA</span></td></tr></table>';
                }
            } else {
                document.getElementById('appendedData').innerHTML = '<div class="text-dim">JPG_ONLY</div>';
            }
        }

        function setBitPlane(plane) {
            if (!app.image) return;

            app.currentBitPlane = plane;
            const canvas = document.getElementById('bitPlaneCanvas');
            const ctx = canvas.getContext('2d');
            canvas.width = app.image.naturalWidth;
            canvas.height = app.image.naturalHeight;

            ctx.drawImage(app.image, 0, 0);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;

            const mask = 1 << plane;

            for (let i = 0; i < data.length; i += 4) {
                const r = (data[i] & mask) ? 255 : 0;
                const g = (data[i + 1] & mask) ? 255 : 0;
                const b = (data[i + 2] & mask) ? 255 : 0;

                data[i] = r;
                data[i + 1] = g;
                data[i + 2] = b;
            }

            ctx.putImageData(imageData, 0, 0);
        }

        // Compression Analysis (NO FAKE LOGIC)
        function analyzeCompression() {
            if (!app.image) {
                document.getElementById('compressionStats').innerHTML = '<div class="text-dim">NOT_AN_IMAGE</div>';
                document.getElementById('noiseStats').innerHTML = '<div class="text-dim">NOT_AN_IMAGE</div>';
                return;
            }

            statusText.textContent = 'ANALYZING_COMPRESSION...';

            // Noise variance analysis
            const noiseCanvas = document.getElementById('noiseCanvas');
            const nCtx = noiseCanvas.getContext('2d');
            noiseCanvas.width = app.image.naturalWidth;
            noiseCanvas.height = app.image.naturalHeight;

            nCtx.drawImage(app.image, 0, 0);
            const imgData = nCtx.getImageData(0, 0, noiseCanvas.width, noiseCanvas.height);
            const data = imgData.data;
            const noiseData = nCtx.createImageData(noiseCanvas.width, noiseCanvas.height);
            const nData = noiseData.data;

            let totalVariance = 0;
            let pixelCount = 0;

            for (let y = 1; y < noiseCanvas.height - 1; y++) {
                for (let x = 1; x < noiseCanvas.width - 1; x++) {
                    const i = (y * noiseCanvas.width + x) * 4;

                    let sum = 0;
                    for (let dy = -1; dy <= 1; dy++) {
                        for (let dx = -1; dx <= 1; dx++) {
                            const ni = ((y + dy) * noiseCanvas.width + (x + dx)) * 4;
                            sum += (data[ni] + data[ni + 1] + data[ni + 2]) / 3;
                        }
                    }
                    const avg = sum / 9;
                    const current = (data[i] + data[i + 1] + data[i + 2]) / 3;
                    const variance = Math.abs(current - avg);

                    totalVariance += variance;
                    pixelCount++;

                    const val = Math.min(255, variance * 10);
                    nData[i] = nData[i + 1] = nData[i + 2] = val;
                    nData[i + 3] = 255;
                }
            }

            nCtx.putImageData(noiseData, 0, 0);

            const avgVariance = (totalVariance / pixelCount).toFixed(4);
            document.getElementById('noiseStats').innerHTML = `
                <table class="data-table">
                    <tr><th>AVG_VARIANCE</th><td>${avgVariance}</td></tr>
                    <tr><th>PIXEL_COUNT</th><td>${pixelCount}</td></tr>
                </table>
            `;

            // Compression variance (simplified ELA-like analysis)
            const compCanvas = document.getElementById('compressionCanvas');
            const cCtx = compCanvas.getContext('2d');
            compCanvas.width = app.image.naturalWidth;
            compCanvas.height = app.image.naturalHeight;

            cCtx.drawImage(app.image, 0, 0);
            const compData = cCtx.getImageData(0, 0, compCanvas.width, compCanvas.height);
            const cData = compData.data;

            let compressionScore = 0;
            for (let i = 0; i < cData.length; i += 4) {
                const gray = (cData[i] + cData[i + 1] + cData[i + 2]) / 3;
                const diff = Math.abs(cData[i] - gray);
                compressionScore += diff;

                // Heatmap visualization
                const heat = Math.min(255, diff * 3);
                cData[i] = heat > 128 ? 255 : heat * 2;
                cData[i + 1] = heat > 128 ? (255 - heat) * 2 : 0;
                cData[i + 2] = 0;
            }

            cCtx.putImageData(compData, 0, 0);

            const avgCompression = (compressionScore / (cData.length / 4)).toFixed(4);
            document.getElementById('compressionStats').innerHTML = `
                <table class="data-table">
                    <tr><th>VARIANCE_SCORE</th><td>${avgCompression}</td></tr>
                    <tr><th>INTERPRETATION</th><td class="text-dim">USER_ANALYSIS_REQUIRED</td></tr>
                </table>
            `;
        }

        // Visual Filters
        function applyFilter(type) {
            if (!app.image) return;

            const canvas = document.getElementById('filterCanvas');
            const ctx = canvas.getContext('2d');
            canvas.width = app.image.naturalWidth;
            canvas.height = app.image.naturalHeight;

            ctx.drawImage(app.image, 0, 0);

            if (type === 'original') return;

            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;

            if (type === 'invert') {
                for (let i = 0; i < data.length; i += 4) {
                    data[i] = 255 - data[i];
                    data[i + 1] = 255 - data[i + 1];
                    data[i + 2] = 255 - data[i + 2];
                }
            } else if (type === 'grayscale') {
                for (let i = 0; i < data.length; i += 4) {
                    const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                    data[i] = data[i + 1] = data[i + 2] = avg;
                }
            } else if (type === 'edge') {
                const w = canvas.width;
                const copy = new Uint8ClampedArray(data);
                for (let y = 1; y < canvas.height - 1; y++) {
                    for (let x = 1; x < w - 1; x++) {
                        const i = (y * w + x) * 4;
                        const gx = -copy[i - 4 - w * 4] + copy[i + 4 - w * 4] - 2 * copy[i - 4] + 2 * copy[i + 4];
                        const val = Math.abs(gx);
                        data[i] = data[i + 1] = data[i + 2] = val;
                    }
                }
            }

            ctx.putImageData(imageData, 0, 0);
        }

        // OCR
        function runOCR() {
            if (!app.image) return;

            const result = document.getElementById('ocrResult');
            result.innerHTML = '<div class="loading">PROCESSING...</div>';
            statusText.textContent = 'RUNNING_OCR...';

            Tesseract.recognize(app.image.src, 'eng', {
                logger: m => console.log(m)
            }).then(({ data: { text } }) => {
                result.textContent = text || 'NO_TEXT_DETECTED';
                statusText.textContent = 'READY';
            });
        }

        // Navigation
        function switchTab(tabId) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');

            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.add('active');
            app.currentTab = tabId;
        }

        // Export
        function exportJSON() {
            if (!app.file) return;

            const report = {
                file: {
                    name: app.file.name,
                    size: app.file.size,
                    type: app.file.type,
                    modified: new Date(app.file.lastModified).toISOString()
                },
                analysis: {
                    timestamp: new Date().toISOString(),
                    compression_variance: document.getElementById('compressionStats')?.textContent || 'N/A',
                    noise_variance: document.getElementById('noiseStats')?.textContent || 'N/A',
                    threat_count: document.getElementById('threatCount')?.textContent || '0',
                    strings_found: document.getElementById('stringCount')?.textContent || '0'
                }
            };

            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `forensics_${app.file.name}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Zoom
        function zoomImage() {
            if (!app.image) return;
            document.getElementById('zoomModal').classList.add('open');
        }

        function closeZoom() {
            document.getElementById('zoomModal').classList.remove('open');
        }

        // Initialize
        init();
    </script>
</body>

</html>
